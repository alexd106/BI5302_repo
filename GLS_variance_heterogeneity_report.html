<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Alex Douglas" />


<title>BI5302 Variance Heterogeneity Practical</title>

<script src="site_libs/header-attrs-2.5/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0/anchor-sections.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">BI5302</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    R Book
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="https://intro2r.com">
        <span class="fa fa-firefox"></span>
         
        Web book
      </a>
    </li>
    <li class="divider"></li>
    <li>
      <a href="https://github.com/alexd106/Rbook/raw/master/docs/Rbook.pdf">
        <span class="fa fa-file-pdf"></span>
         
        PDF book
      </a>
    </li>
  </ul>
</li>
<li>
  <a href="exercises.html">
    <span class="fa fa-book"></span>
     
    Exercises
  </a>
</li>
<li>
  <a href="data.html">
    <span class="fa fa-download"></span>
     
    Data
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-question-circle"></span>
     
    Info
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="resources.html">
        <span class="fa fa-book"></span>
         
        Resources
      </a>
    </li>
    <li>
      <a href="https://github.com/alexd106/BI5302_repo">
        <span class="fa fa-github fa-lg"></span>
         
        Source code
      </a>
    </li>
    <li>
      <a href="https://twitter.com/Scedacity">
        <span class="fa fa-twitter fa-lg"></span>
         
        Twitter
      </a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">BI5302 Variance Heterogeneity Practical</h1>
<h4 class="author">Alex Douglas</h4>
<h4 class="date">18 December, 2020</h4>

</div>


<p> </p>
<p>Setup global options for knitr package. Normally I wouldn’t display these but I’ll leave them here for your information. The arguments <code>width.cutoff</code> and <code>tidy = TRUE</code> keeps the displayed code within the code boxes (see what happens if you omit this).</p>
<p> </p>
<pre class="r"><code>knitr::opts_chunk$set(echo=TRUE,tidy.opts=list(width.cutoff=55),tidy=TRUE)</code></pre>
<p> </p>
<div id="benthic-biodiversity-experiment" class="section level3">
<h3>Benthic Biodiversity experiment</h3>
<p>These data were obtained from a mesocosm experiment which aimed to examine the effect of benthic polychaete (<em>Hediste diversicolor</em>) biomass on sediment nutrient release (NH<sub>4</sub>, NO<sub>3</sub> and PO<sub>3</sub>). At the start of the experiment replicate mesocosms were filled with homogenised marine sediment and assigned to one of five polychaete biomass treatments (0, 0.5, 1, 1.5, 2 g per mesocosm). The mesocosms were allowed to acclimatise for 24 h after which the concentration of either NH<sub>4</sub>, NO<sub>3</sub> or PO<sub>3</sub> was measured in the water. The concentration of only one nutrient was measured in each mesocosm. The researchers were particularly interested in whether the nutrient concentration differed between polychaete biomass treatments and whether these effects were dependent on the nutrient.</p>
<p> </p>
<p>1. Create a new R markdown document in your BI5302 RStudio project and save it using a suitable file name. I suggest you specify the default output format as html but feel free to experiment with pdf (you can always change this later). Use this R markdown document to record your data exploration, statistical analysis (including graphs and tables) and commentary. For this exercise I would also suggest that you embed your R code as visible chunks within the document (use <code>echo = TRUE</code>) for later reference.</p>
<p> </p>
<p>Import all the packages required for this exercise:</p>
<p> </p>
<pre class="r"><code>library(nlme)
library(effects)
library(ggplot2)  # this is optional</code></pre>
<p> </p>
<p>2. Import the <code>Hediste.txt</code> dataset into R and assign it to a suitably named variable. Remember if you’re using R version &gt; 4.0.0 (most of you will be) then columns containing character strings will be imported into R as character type variables not as factors by default. You can either use the argument <code>stringsAsFactors = TRUE</code> when you use the <code>read.table()</code> function to automatically convert character type variables to factors when you import your data or you can use the <code>read.table()</code> function without the <code>stringsAsFactors = TRUE</code> argument and then covert them after you import your data. Examine the structure of the dataframe and convert the <code>biomass</code> variable to a factors and store it as a new variable in your dataframe.</p>
<p> </p>
<pre class="r"><code>nereis &lt;- read.table(&quot;data/Hediste.txt&quot;, header = TRUE, 
    stringsAsFactors = TRUE)

nereis$fbiomass &lt;- factor(nereis$biomass)
str(nereis)
## &#39;data.frame&#39;:    45 obs. of  4 variables:
##  $ concentration: num  0.05 0.105 0.105 0.79 0.21 ...
##  $ biomass      : num  0 0 0 0.5 0.5 0.5 1 1 1 1.5 ...
##  $ fnutrient    : Factor w/ 3 levels &quot;NH4&quot;,&quot;NO3&quot;,&quot;PO3&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ fbiomass     : Factor w/ 5 levels &quot;0&quot;,&quot;0.5&quot;,&quot;1&quot;,..: 1 1 1 2 2 2 3 3 3 4 ...</code></pre>
<p> </p>
<p>3. How many replicates are there for each biomass and nutrient combination?</p>
<p> </p>
<pre class="r"><code>xtabs(~fbiomass + fnutrient, data = nereis)
##         fnutrient
## fbiomass NH4 NO3 PO3
##      0     3   3   3
##      0.5   3   3   3
##      1     3   3   3
##      1.5   3   3   3
##      2     3   3   3</code></pre>
<p> </p>
<p>There are 3 replicates per <code>fbiomass</code> and <code>fnutrient</code> combination.</p>
<p> </p>
<p>4. Explore these data graphically. Are there any obvious outliers in the <code>concentration</code> variable for each of the <code>biomass</code> or <code>nutrient</code> variable levels (perhaps the <code>dotchart()</code> function with the <code>group</code> argument might help)? Use an appropriate plot to examine whether there are any biomass and/or nutrient effects on concentration (perhaps a boxplot?). Do you notice a potential issue regarding the between group variances?</p>
<p> </p>
<pre class="r"><code>dotchart(nereis$concentration, groups = nereis$fnutrient, 
    col = as.numeric(nereis$fnutrient), xlab = &quot;Concentration&quot;, 
    ylab = &quot;Order of observations&quot;)</code></pre>
<p><img src="GLS_variance_heterogeneity_report_files/figure-html/q4a-1.png" width="432" style="display: block; margin: auto;" /></p>
<p> </p>
<pre class="r"><code>dotchart(nereis$concentration, groups = nereis$fbiomass, 
    col = as.numeric(nereis$fbiomass), xlab = &quot;Concentration&quot;, 
    ylab = &quot;Order of observations&quot;)</code></pre>
<p><img src="GLS_variance_heterogeneity_report_files/figure-html/q4b-1.png" width="432" style="display: block; margin: auto;" /></p>
<p> </p>
<p>There doesn’t appear to be any obvious outliers in the <code>concentration</code> variable for the <code>fbiomass</code> and <code>fnutrient</code> groups.</p>
<p>Are there any differences in concentration between the biomass treatment? Are these differences dependent on the type of nutrient? Let’s use a boxplot to explore this further (see the end of this document for an alternative approach to creating this boxplot using the <code>ggplot()</code> function).</p>
<p> </p>
<pre class="r"><code>boxplot(concentration ~ fbiomass * fnutrient, xlab = &quot;biomass (g)&quot;, 
    main = &quot;&quot;, ylab = &quot;concentration (mg/l)&quot;, data = nereis, 
    cex.axis = 0.8, col = rep(c(&quot;deepskyblue&quot;, &quot;yellowgreen&quot;, 
        &quot;deeppink3&quot;), each = 5), names = rep(c(0, 0.5, 1, 
        1.5, 2), 3))

legend(&quot;topright&quot;, col = c(&quot;deepskyblue&quot;, &quot;yellowgreen&quot;, 
    &quot;deeppink3&quot;), legend = c(&quot;NH4&quot;, &quot;NO3&quot;, &quot;PO3&quot;), pch = 16)</code></pre>
<p><img src="GLS_variance_heterogeneity_report_files/figure-html/q4c-1.png" width="576" style="display: block; margin: auto;" /></p>
<p> </p>
<p>There does appear to be a difference in the nutrient concentration between biomass treatments and this seems to be dependent on the nutrient type. Overall, NO<sub>3</sub> has the highest nutrient concentration compared to NH<sub>4</sub> and PO<sub>3</sub>. Nutrient concentration appears to be consistently low for PO<sub>3</sub> regardless of polychaete biomass whereas for NH<sub>4</sub> the concentration increases with biomass and for NO<sub>3</sub> the concentration decreases with an increase in biomass. This suggests that there is an interaction between biomass and nutrient type.</p>
<p> </p>
<p>5. With reference to the study aims stated above, fit an appropriate linear model to these data using the <code>lm()</code> function.</p>
<p> </p>
<pre class="r"><code>nereis.lm &lt;- lm(concentration ~ fbiomass * fnutrient, data = nereis)</code></pre>
<p> </p>
<p>The code above fits a linear model using the <code>lm()</code> function with <code>concentration</code> as the response variable and <code>fbiomass</code> and <code>fnutrient</code> as explanatory variables. It also includes an interaction between <code>fbiomass</code> and <code>fnutrient</code>.</p>
<p> </p>
<p>6. Use appropriate residual plots to identify whether the modelling assumptions are met. Don’t forget to also plot the residuals from this model against all explanatory variables. Can you see a problem? Can you assume homogeneity of variance of the residuals from your model? If not, then try to identify the cause of this problem. Make sure you describe and discuss this process in your Rmarkdown document.</p>
<p> </p>
<p>First let’s create the usual residual plots using the <code>plot()</code> function on the <code>lm</code> model object <code>nereis.lm</code>. Don’t forget to split the plotting device into 2 rows and 2 columns so we can visualise all the plots together.</p>
<p> </p>
<pre class="r"><code>par(mfrow = c(2, 2))
plot(nereis.lm)</code></pre>
<p><img src="GLS_variance_heterogeneity_report_files/figure-html/q6-1.png" width="528" style="display: block; margin: auto;" /></p>
<p> </p>
<p>From the Residual vs Fitted and Scale-Location plots (left-hand side) you can clearly see that the residual variance is different for each of the treatment groups. Larger fitted values have a wider spread and small fitted values a narrower spread. This is a clear violation of the homogeneity of variance assumption!</p>
<p> </p>
<p>Let’s try to find which of the explanatory variable(s) is responsible for these differences in residual variance. First we plot the residuals from our linear model against the <code>fbiomass</code> variable.</p>
<p> </p>
<pre class="r"><code>plot(resid(nereis.lm) ~ nereis$fbiomass, xlab = &quot;Biomass&quot;, 
    ylab = &quot;Residuals&quot;)
abline(h = 0, lty = 2, col = 2)</code></pre>
<p><img src="GLS_variance_heterogeneity_report_files/figure-html/unnamed-chunk-1-1.png" width="364.8" style="display: block; margin: auto;" /></p>
<p> </p>
<p>There are clear differences in the residual variance between each of the biomass levels. The zero biomass treatment has very little residual variance (as we might expect - why?) whereas the highest biomass group (2 g) has a very large within group variance. There are also differences between the other biomass groups but these are less pronounced.</p>
<p>We should also plot the residuals from our model against the <code>fnutrient</code> explanatory variable.</p>
<p> </p>
<pre class="r"><code>plot(resid(nereis.lm) ~ nereis$fnutrient, xlab = &quot;Nutrient&quot;, 
    ylab = &quot;Residuals&quot;)
abline(h = 0, lty = 2, col = 2)</code></pre>
<p><img src="GLS_variance_heterogeneity_report_files/figure-html/unnamed-chunk-2-1.png" width="364.8" style="display: block; margin: auto;" /></p>
<p> </p>
<p>Again, the residual variance between the three nutrient types is different. The PO<sub>3</sub> nutrient appears to have the smallest variance whereas the NO<sub>3</sub> nutrient has the largest variance. Both of these plots suggest that the cause of our heterogeneity of variance is both the <code>fbiomass</code> and <code>fnutrient</code> variables. Therefore we need fit a model that allows for different variances in each of our <code>fbiomass</code> and <code>fnutrient</code> variables. To do this we will fit a Generalised Least Squares model using the <code>gls()</code> function from the <code>nlme</code> package.</p>
<p> </p>
<p>7. Import the <code>nlme</code> package into R.</p>
<p> </p>
<pre class="r"><code># I usually import any packages I am going to use in my
# analysis at the top of my R script or R markdown
# document. See above.

# if you want to do it here then library(nlme)</code></pre>
<p> </p>
<p>You will see that I have already done this at the top of this Rmarkdown document using the <code>library()</code> function. It’s good practice to import all the packages required for a particular analysis near the start of your script.</p>
<p> </p>
<p>8. Use the <code>gls()</code> function from the <code>nlme</code> package without any variance covariates to refit your linear model specified above (the model you fitted using the <code>lm()</code> function). This GLS model with no variance structure is equivalent to a standard linear model. You will use this GLS model to compare with models you subsequently fit. If you are not convinced that these two models are equivalent then compare the output from both models (and replot the residuals if you’re still not convinced!). Why do you need to refit this model using the <code>gls()</code> function? (Hint: take a look at the AICs from both models).</p>
<p> </p>
<pre class="r"><code>nereis.gls1 &lt;- gls(concentration ~ fbiomass * fnutrient, 
    data = nereis)</code></pre>
<p> </p>
<p>Comparing the AICs from the model fitted with the <code>lm()</code> function and the model fitted using the <code>gls()</code> function.</p>
<p> </p>
<pre class="r"><code>AIC(nereis.lm)
## [1] 105.497
AIC(nereis.gls1)
## [1] 109.6412</code></pre>
<p> </p>
<p>As you can see the AICs are different between these two equivalent models. Don’t be fooled though, this is because the AICs are calculated slightly differently for <code>lm</code> and <code>gls</code> class objects so you cannot use them to compare <code>lm</code> models with <code>gls</code> models (that’s why we need to refit our linear model using the <code>gls()</code> function).</p>
<p> </p>
<p>9. With reference to the residual plots you created above, fit models with different variance covariate structures to account for the heterogeneity of variance you identified previously. You will first need to decide which variance structure to use (and which R function to use). I suggest that you start with a simple variance structure and then build up to a more complicated structure. Remember to use the <code>weights =</code> argument with the <code>gls()</code> function to specify your variance structure. Use the <code>AIC()</code> function to compare each of your models with different variance structures. Identify the model with the most appropriate variance covariate structure. Describe and justify your process in your Rmarkdown document.</p>
<p>Let’s first use the <code>fbiomass</code> variable as our variance covariate as our residual plots suggested substantial residual heterogeneity between biomass levels. First we will specify the variance structure using the <code>varIdent()</code> function (as our variance covariate is a categorical variable) and then include this in our <code>gls</code> model using the <code>weights =</code> argument.</p>
<p> </p>
<pre class="r"><code>vf1 &lt;- varIdent(form = ~1 | fbiomass)
nereis.gls2 &lt;- gls(concentration ~ fbiomass * fnutrient, 
    weights = vf1, data = nereis)</code></pre>
<p> </p>
<p>Alternatively you can include the variance structure directly when using the <code>gls()</code> function.</p>
<p> </p>
<pre class="r"><code>nereis.gls2 &lt;- gls(concentration ~ fbiomass * fnutrient, 
    weights = varIdent(form = ~1 | fbiomass), data = nereis)</code></pre>
<p> </p>
<p>These two are equivalent but I prefer the first method.</p>
<p>Now we can compare our linear model fitted with the <code>gls()</code> function (<code>nereis.gls1</code>) with our model allowing for different variances per biomass level (<code>nereis.gls2</code>).</p>
<p> </p>
<pre class="r"><code>AIC(nereis.gls1, nereis.gls2)
##             df      AIC
## nereis.gls1 16 109.6412
## nereis.gls2 20 110.6647</code></pre>
<p> </p>
<p>That’s strange, the model estimating different variances per biomass level has a higher AIC value compared to our linear model indicating a poorer fit. Why might this be? We get a clue by looking at the degrees of freedom (df) column in the output of the <code>AIC()</code> function. You can see that we are estimating 4 more parameters for our <code>nereis.gls2</code> model (df = 20) compared to our linear model <code>nereis.gls1</code> (df = 16). As AIC is a measure of goodness of fit which is penalised by the number of parameters estimated this suggests that the improvement in goodness of fit for our <code>nereis.gls2</code> model is not large enough to compensate for the higher number of parameters estimated.</p>
<p>OK, let try to fit another model but this time allow for the variances to differ between <code>fnutrient</code> levels.</p>
<p> </p>
<pre class="r"><code>vf2 &lt;- varIdent(form = ~1 | fnutrient)
nereis.gls3 &lt;- gls(concentration ~ fbiomass * fnutrient, 
    weights = vf2, data = nereis)</code></pre>
<p> </p>
<p>And once again compare all models using AIC.</p>
<p> </p>
<pre class="r"><code>AIC(nereis.gls1, nereis.gls2, nereis.gls3)
##             df      AIC
## nereis.gls1 16 109.6412
## nereis.gls2 20 110.6647
## nereis.gls3 18 106.4491</code></pre>
<p> </p>
<p>So, the model allowing for different variances per <code>fnutrient</code> level appears to be our best model so far.</p>
<p>Now let’s fit a final model which estimates a separate variance for each <code>fbiomass</code> and <code>fnutrient</code> combination (note: this is quite a lot of parameters given the level of replication in our dataset!).</p>
<p> </p>
<pre class="r"><code>vf3 &lt;- varIdent(form = ~1 | fnutrient * fbiomass)
nereis.gls4 &lt;- gls(concentration ~ fbiomass * fnutrient, 
    weights = vf3, data = nereis)</code></pre>
<p> </p>
<p>And again compare all models with AIC.</p>
<p> </p>
<pre class="r"><code>AIC(nereis.gls1, nereis.gls2, nereis.gls3, nereis.gls4)
##             df      AIC
## nereis.gls1 16 109.6412
## nereis.gls2 20 110.6647
## nereis.gls3 18 106.4491
## nereis.gls4 30 100.2198</code></pre>
<p> </p>
<p>This suggests that the model with both <code>fbiomass</code> and <code>fnutrient</code> as variance covariates (<code>nereis.gls4</code>) is by far the best model (lots of parameters estimated though).</p>
<p> </p>
<p>10. Now that your model has the optimal variance covariate structure it’s time to perform model selection to identify the optimal fixed effects structure. To do this you will have to refit your optimal model (in terms of variance structure) using maximum likelihood estimation (ML) rather than the default restricted maximum likelihood estimation (REML). To do this use the argument <code>method = "ML"</code> with the <code>gls()</code> function.</p>
<p> </p>
<p>OK, now we have our model with the optimal variance covariate structure, we need to identify the model with the best fixed effects structure. We will use our <code>nereis.gls4</code> model as a starting point but first we need to refit our model using maximum likelihood (ML) rather than restricted maximum likelihood (REML) before we perform model selection on our fixed effects.</p>
<p> </p>
<pre class="r"><code>nereis.gls4.ml &lt;- gls(concentration ~ fbiomass * fnutrient, 
    weights = vf3, method = &quot;ML&quot;, data = nereis)</code></pre>
<p> </p>
<p>11. Perform model selection using AIC to compare model fit. Select the model with the most appropriate fixed effects structure. Describe this process in your R markdown document. If you are feeling adventurous (this is optional!) you can also perform model selection by comparing nested models using likelihood ratio tests (using the <code>anova()</code> function). Does this result in the same final model?</p>
<p> </p>
<p>First we will fit a model without the interaction term <code>fbiomass:fnutrient</code></p>
<p> </p>
<pre class="r"><code>nereis.gls5.ml &lt;- gls(concentration ~ fbiomass + fnutrient, 
    weights = vf3, method = &quot;ML&quot;, data = nereis)</code></pre>
<p> </p>
<p>And compare this model (<code>nereis.gls5.ml</code>) with the model including the interaction term (<code>nereis.gls4.ml</code>) using AIC.</p>
<p> </p>
<pre class="r"><code>AIC(nereis.gls4.ml, nereis.gls5.ml)
##                df      AIC
## nereis.gls4.ml 30 77.36504
## nereis.gls5.ml 22 81.12361</code></pre>
<p> </p>
<p>A difference in AIC of 3.76 suggests that the model including the interaction term between <code>fbiomass</code> and <code>fnutrient</code> is our optimal model (<code>nereis.gls4.ml</code>). In other words, when we remove the interaction term from the model the AIC increases from 77.37 to 81.12 and therefore we prefer the model including the interaction term. The good news is that no more model selection is required!!</p>
<p> </p>
<p>As the <code>nereis.gls5.ml</code> is nested within the <code>nereis.gls4.ml</code> model we can (as an optional extra!) compare these models using a likelihood ratio test using the <code>anova()</code> function.</p>
<p> </p>
<pre class="r"><code>anova(nereis.gls4.ml, nereis.gls5.ml)
##                Model df      AIC      BIC     logLik   Test  L.Ratio p-value
## nereis.gls4.ml     1 30 77.36504 131.5649  -8.682522                        
## nereis.gls5.ml     2 22 81.12361 120.8702 -18.561806 1 vs 2 19.75857  0.0113</code></pre>
<p> </p>
<p>A <em>p-value</em> of 0.011 suggests that the interaction term should not be dropped. Therefore, the model selection based on AIC and the model selection based on a likelihood ratio test results in the same final model (this might not always be the case!).</p>
<p> </p>
<p>12. Once you have your model with optimal variance covariate and fixed effects structures refit this model using REML. This is your final model.</p>
<p> </p>
<pre class="r"><code>nereis.gls.final &lt;- gls(concentration ~ fbiomass * fnutrient, 
    weights = vf3, method = &quot;REML&quot;, data = nereis)</code></pre>
<p> </p>
<p>Note: For clarity, I have included the <code>method = "REML"</code> argument when using the <code>gls()</code> function this time although this is not strictly necessary as REML is the default value for this argument (see the help file for the <code>gls()</code> function for additional information).</p>
<p> </p>
<p>13. Extract the normalised (variance scaled) residuals and fitted values from your final model. Plot the normalised residuals against the fitted values. Can you assume homogeneity of residual variance now? Also plot your normalised residuals against each of your explanatory variables? Comment on the model assumptions and contrast these with the naive linear model.</p>
<p> </p>
<p>First lets extract the normalised residuals from our final model using the <code>resid()</code> function including the argument <code>type = normalized</code> and the fitted values using the <code>fitted()</code> function.</p>
<p> </p>
<pre class="r"><code>nereis.res1 &lt;- resid(nereis.gls.final, type = &quot;normalized&quot;)
nereis.fit1 &lt;- fitted(nereis.gls.final)</code></pre>
<p> </p>
<p>And now create the plot</p>
<p> </p>
<pre class="r"><code>plot(nereis.fit1, nereis.res1, ylab = &quot;normalised residuals&quot;, 
    xlab = &quot;fitted values&quot;)
abline(h = 0, lty = 2, col = 2)</code></pre>
<p><img src="GLS_variance_heterogeneity_report_files/figure-html/q13b-1.png" width="384" style="display: block; margin: auto;" /></p>
<p> </p>
<p>This looks a lot better than the equivalent plot from the first linear model we fitted (go back and take a look). It appears that the assumption of homogeneity of residual variance is now satisfied. An easier (but perhaps less transparent) way to create this plot (not shown) is :</p>
<p> </p>
<pre class="r"><code>plot(nereis.gls.final, resid(., type = &quot;normalized&quot;) ~ fitted(.))</code></pre>
<p> </p>
<p>We should also plot our normalised residual against each of our explanatory variables.</p>
<p> </p>
<pre class="r"><code>par(mfrow = c(1, 2))
plot(nereis$fbiomass, nereis.res1)
abline(h = 0, lty = 2, col = 2)
plot(nereis$fnutrient, nereis.res1)
abline(h = 0, lty = 2, col = 2)</code></pre>
<p><img src="GLS_variance_heterogeneity_report_files/figure-html/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;" /></p>
<p> </p>
<p>Again, these look much better than for our naive linear model.</p>
<p>As before, we can use a short cut to obtain similar plots (not shown):</p>
<p> </p>
<pre class="r"><code>plot(nereis.gls.final, fnutrient ~ resid(., type = &quot;normalized&quot;))
plot(nereis.gls.final, fbiomass ~ resid(., type = &quot;normalized&quot;))</code></pre>
<p> </p>
<p>14. Now (and only now!) you can go ahead and interpret the the output from your final model (use the <code>anova()</code> and <code>summary()</code> functions). Summarise your interpretation in your R markdown document.</p>
<p> </p>
<p>Display the ANOVA table using the <code>anova()</code> function. This highlights the significant interaction term between <code>fbiomass</code> and <code>fnutrient</code> variables. In fact, notice the interaction term <em>p-value</em> is the same (within rounding error) as the one obtained using the likelihood ratio test above.</p>
<p> </p>
<pre class="r"><code>anova(nereis.gls.final)
## Denom. DF: 30 
##                    numDF   F-value p-value
## (Intercept)            1 119.15883  &lt;.0001
## fbiomass               4  49.67333  &lt;.0001
## fnutrient              2  22.93364  &lt;.0001
## fbiomass:fnutrient     8   3.01002  0.0133</code></pre>
<p> </p>
<p>To display the parameter estimates we use the <code>summary()</code> function. Prepare for voluminous output! Take note of the <code>Variance function:</code> section which displays the multiplication factors for each of our treatment group (<code>fbiomass</code> and <code>fnutrient</code>) combinations. We can use these multiplication factors to multiply the residual standard error from the model, (0.0318), to give us our group standard deviations and then square these values to give us our group level variance estimates (i.e. for the NH4<code>*</code>0.5 group: (30.48 x 0.0318)<sup>2</sup> = 0.939). The parameter estimates are provided in the form of treatment contrasts (remember those!) which will take you quite a while to work through (see below for some help).</p>
<p> </p>
<pre class="r"><code>summary(nereis.gls.final)
## Generalized least squares fit by REML
##   Model: concentration ~ fbiomass * fnutrient 
##   Data: nereis 
##        AIC      BIC    logLik
##   100.2198 142.2558 -20.10992
## 
## Variance function:
##  Structure: Different standard deviations per stratum
##  Formula: ~1 | fnutrient * fbiomass 
##  Parameter estimates:
##     NH4*0   NH4*0.5     NH4*1   NH4*1.5     NH4*2     NO3*0   NO3*0.5     NO3*1   NO3*1.5     NO3*2     PO3*0   PO3*0.5     PO3*1   PO3*1.5 
##  1.000000 30.490662 10.433659  9.512390 43.814615 41.570039 22.368561 16.553389 18.043296 15.284863  1.196884 15.889925  6.693475  5.688974 
##     PO3*2 
## 15.730721 
## 
## Coefficients:
##                              Value Std.Error   t-value p-value
## (Intercept)               0.086667 0.0183334  4.727261  0.0001
## fbiomass0.5               0.946667 0.5592974  1.692600  0.1009
## fbiomass1                 0.807567 0.1921608  4.202557  0.0002
## fbiomass1.5               1.113000 0.1753553  6.347115  0.0000
## fbiomass2                 2.595333 0.8034792  3.230119  0.0030
## fnutrientNO3              2.413333 0.7623398  3.165692  0.0035
## fnutrientPO3              0.041733 0.0285938  1.459524  0.1548
## fbiomass0.5:fnutrientNO3 -0.501667 1.0304438 -0.486845  0.6299
## fbiomass1:fnutrientNO3   -1.342567 0.8425268 -1.593500  0.1215
## fbiomass1.5:fnutrientNO3 -1.858000 0.8491174 -2.188154  0.0366
## fbiomass2:fnutrientNO3   -3.490333 1.1423352 -3.055437  0.0047
## fbiomass0.5:fnutrientPO3 -0.348133 0.6309993 -0.551717  0.5852
## fbiomass1:fnutrientPO3   -0.279900 0.2290546 -1.221980  0.2312
## fbiomass1.5:fnutrientPO3 -0.586533 0.2052049 -2.858281  0.0077
## fbiomass2:fnutrientPO3   -1.906533 0.8539516 -2.232601  0.0332
## 
##  Correlation: 
##                          (Intr) fbm0.5 fbmss1 fbm1.5 fbmss2 fntNO3 fntPO3 f0.5:N f1:NO3 f1.5:N f2:NO3 f0.5:P f1:PO3 f1.5:P
## fbiomass0.5              -0.033                                                                                           
## fbiomass1                -0.095  0.003                                                                                    
## fbiomass1.5              -0.105  0.003  0.010                                                                             
## fbiomass2                -0.023  0.001  0.002  0.002                                                                      
## fnutrientNO3             -0.024  0.001  0.002  0.003  0.001                                                               
## fnutrientPO3             -0.641  0.021  0.061  0.067  0.015  0.015                                                        
## fbiomass0.5:fnutrientNO3  0.018 -0.543 -0.002 -0.002  0.000 -0.740 -0.011                                                 
## fbiomass1:fnutrientNO3    0.022 -0.001 -0.228 -0.002  0.000 -0.905 -0.014  0.669                                          
## fbiomass1.5:fnutrientNO3  0.022 -0.001 -0.002 -0.207  0.000 -0.898 -0.014  0.664  0.812                                   
## fbiomass2:fnutrientNO3    0.016 -0.001 -0.002 -0.002 -0.703 -0.667 -0.010  0.494  0.604  0.599                            
## fbiomass0.5:fnutrientPO3  0.029 -0.886 -0.003 -0.003 -0.001 -0.001 -0.045  0.481  0.001  0.001  0.000                     
## fbiomass1:fnutrientPO3    0.080 -0.003 -0.839 -0.008 -0.002 -0.002 -0.125  0.001  0.191  0.002  0.001  0.006              
## fbiomass1.5:fnutrientPO3  0.089 -0.003 -0.009 -0.855 -0.002 -0.002 -0.139  0.002  0.002  0.176  0.001  0.006  0.017       
## fbiomass2:fnutrientPO3    0.021 -0.001 -0.002 -0.002 -0.941 -0.001 -0.033  0.000  0.000  0.000  0.662  0.002  0.004  0.005
## 
## Standardized residuals:
##         Min          Q1         Med          Q3         Max 
## -1.15469760 -0.85036560  0.05707306  0.79914114  1.13019396 
## 
## Residual standard error: 0.03175435 
## Degrees of freedom: 45 total; 30 residual

# if you want less output you can use the slightly hacky
# code to return the variance inflation factors
# summary(nereis.gls.final)$modelStruct$varStruct

# and the summary table of parameter estimates
# summary(nereis.gls.final)$tTable</code></pre>
<p> </p>
<p>OK, that’s quite a few parameter estimates! Let’s work through the interpretation of each of them in turn to clarify what they actually are and what they mean.</p>
<ul>
<li><p>As always we start with the <strong><code>intercept</code></strong> estimate. In this model, the <code>intercept</code> is 0.0867 and represents the estimated mean concentration at <code>fbiomass</code> level 0 for the NH4 <code>fnutrient</code> (this is first alphabetically).</p></li>
<li><p>Next the <strong><code>fbiomass0.5</code></strong> estimate (0.9467) is the <em>difference</em> in mean concentration between <code>fbiomass</code> level 0 for <code>fnutrient</code> NH4 (the intercept) and <code>fbiomass</code> level 0.5 and <code>fnutrient</code> NH4. In other words, the nutrient concentration for <code>fbiomass</code> level 0.5 and <code>fnutrient</code> NH4 is 0.9467 higher than the <code>intercept</code>. If you want to calculate the concentration for the <code>fbiomass</code> level 0.5 and <code>fnutrient</code> NH4 group then you simply take the <code>intercept</code> value and add it to the <code>fbiomass0.5</code> value 0.0867 + 0.9467 = 1.0334 mg/l.</p></li>
<li><p>The estimate for <strong><code>fbiomass1</code></strong> (0.8076) is the <em>difference</em> in mean concentration between <code>fbiomass</code> level 0 for <code>fnutrient</code> NH4 (the intercept) and <code>fbiomass</code> level 1 and <code>fnutrient</code> NH4. In other words, the nutrient concentration for <code>fbiomass</code> level 1 and <code>fnutrient</code> NH4 is 0.8076 higher than the <code>intercept</code>. Again, if you want to calculate the concentration for the <code>fbiomass</code> level 1 and <code>fnutrient</code> NH4 group then you simply take the <code>intercept</code> value and add it to the <code>fbiomass1</code> value 0.0867 + 0.8076 = 0.8943 mg/l.</p></li>
<li><p>The estimates for <strong><code>fbiomass1.5</code></strong> and <strong><code>fbiomass2</code></strong> are interpreted in the same way as above.</p></li>
<li><p>The <strong><code>fnutrientNO3</code></strong> estimate of 2.4133 is the <em>difference</em> in mean concentration between <code>fbiomass</code> level 0 for <code>fnutrient</code> NH4 (the intercept) and <code>fbiomass</code> level 0 and <code>fnutrient</code> NO3. So the nutrient concentration for <code>fbiomass</code> level 0 and <code>fnutrient</code> NO3 is 2.4133 higher than the <code>intercept</code>. To calculate the mean concentration for the <code>fbiomass</code> level 0 and <code>fnutrient</code> NO3 group then you simply take the <code>intercept</code> value and add it to the <code>fnutrientNO3</code> value 0.0867 + 2.4133 = 2.5 mg/l.</p></li>
<li><p>The <strong><code>fnutrientPO3</code></strong> estimate of 0.0417 is the <em>difference</em> in mean concentration between <code>fbiomass</code> level 0 for <code>fnutrient</code> NH4 (the intercept) and <code>fbiomass</code> level 0 and <code>fnutrient</code> PO3. So the nutrient concentration for <code>fbiomass</code> level 0 and <code>fnutrient</code> PO3 is 0.0417 higher than the <code>intercept</code>. To calculate the mean concentration for the <code>fbiomass</code> level 0 and <code>fnutrient</code> PO3 group then you simply take the <code>intercept</code> value and add it to the <code>fnutrientNO3</code> value 0.0867 + 0.0417 = 0.1284 mg/l.</p></li>
<li><p>The <strong><code>fbiomass0.5:fnutrientNO3</code></strong> estimate (-0.5017) is the <em>difference</em> of the <em>difference</em> in mean concentration between <code>fbiomass</code> level 0 for <code>fnutrient</code> NH4 (the intercept) and <code>fbiomass</code> level 0.5 and <code>fnutrient</code> NO3. So, to calculate this difference we need to add the estimate of <code>fbiomass0.5</code> (0.9467) and the estimate of <code>fnutrientNO3</code> (2.4133) to the <code>fbiomass0.5:fnutrientNO3</code> estimate (because its a <em>difference</em> of a <em>difference</em>). So the difference is 0.9467 + 2.4133 + -0.5017 = 2.8583. To obtain the mean concentration for the <code>fbiomass</code> level 0.5 and <code>fnutrient</code> NO3 group we simply add this difference to the intercept 0.9467 + 2.4133 + -0.5017 + 0.0867 = 2.945 mg/l.</p></li>
<li><p>The <strong><code>fbiomass1:fnutrientNO3</code></strong> estimate (-1.3426) is the <em>difference</em> of the <em>difference</em> in mean concentration between <code>fbiomass</code> level 0 for <code>fnutrient</code> NH4 (the intercept) and <code>fbiomass</code> level 1 and <code>fnutrient</code> NO3. So, to calculate this difference we need to add the estimate of <code>fbiomass1</code> (0.8076) and the estimate of <code>fnutrientNO3</code> (2.4133) to the <code>fbiomass1:fnutrientNO3</code> estimate (because its a <em>difference</em> of a <em>difference</em>). So the difference is 0.8076 + 2.4133 + -1.3426 = 1.8783. To obtain the mean concentration for the <code>fbiomass</code> level 1 and <code>fnutrient</code> NO3 group we simply add this difference to the intercept 0.8076 + 2.4133 + -1.3426 + 0.0867 = 1.965 mg/l.</p></li>
<li><p><strong><code>fbiomass1.5:fnutrientNO3</code></strong> and <strong><code>fbiomass2:fnutrientNO3</code></strong> are interpreted in the same way.</p></li>
<li><p>The <strong><code>fbiomass0.5:fnutrientPO3</code></strong> estimate of -0.3481 is the <em>difference</em> of the <em>difference</em> in mean concentration between <code>fbiomass</code> level 0 for <code>fnutrient</code> NH4 (the intercept) and <code>fbiomass</code> level 0.5 and <code>fnutrient</code> PO3. So, to calculate this difference we need to add the estimate of <code>fbiomass0.5</code> (0.9467) and the estimate of <code>fnutrientPO3</code> (0.0417) to the <code>fbiomass0.5:fnutrientPO3</code> estimate (because its a <em>difference</em> of a <em>difference</em>). So the difference is 0.9467 + 0.0417 + -0.3481 = 0.6403. To obtain the mean concentration for the <code>fbiomass</code> level 0.5 and <code>fnutrient</code> PO3 group we simply add this difference to the intercept 0.9467 + 0.0417 + -0.3481 + 0.0867 = 0.7269 mg/l.</p></li>
<li><p>The <strong><code>fbiomass1:fnutrientPO3</code></strong> estimate of -0.2799 is the <em>difference</em> of the <em>difference</em> in mean concentration between <code>fbiomass</code> level 0 for <code>fnutrient</code> NH4 (the intercept) and <code>fbiomass</code> level 1 and <code>fnutrient</code> PO3. So, to calculate this difference we need to add the estimate of <code>fbiomass1</code> (0.8076) and the estimate of <code>fnutrientPO3</code> (0.0417) to the <code>fbiomass1:fnutrientPO3</code> estimate (because its a <em>difference</em> of a <em>difference</em>). So the difference is 0.8076 + 0.0417 + -0.2799 = 0.5694. To obtain the mean concentration for the <code>fbiomass</code> level 1 and <code>fnutrient</code> PO3 group we simply add this difference to the intercept 0.8076 + 0.0417 + -0.2799 + 0.0867 = 0.6561 mg/l.</p></li>
<li><p><strong><code>fbiomass1.5:fnutrientPO3</code></strong> and <strong><code>fbiomass2:fnutrientPO3</code></strong> are interpreted in the same way.</p></li>
</ul>
<p> </p>
<p>Wow, interpreting all of the those parameter estimates and calculating all those differences by hand was a pain (but hopefully instructive, possibly I’ve just bamboozled you!). Actually, you can get these values with less number crunching by using the <code>effect()</code> function form the <code>effects</code> package.</p>
<p> </p>
<pre class="r"><code>effect(term = &quot;fbiomass*fnutrient&quot;, mod = nereis.gls.final)
## 
##  fbiomass*fnutrient effect
##         fnutrient
## fbiomass        NH4   NO3       PO3
##      0   0.08666667 2.500 0.1284000
##      0.5 1.03333333 2.945 0.7269333
##      1   0.89423333 1.965 0.6560667
##      1.5 1.19966667 1.755 0.6548667
##      2   2.68200000 1.605 0.8172000</code></pre>
<p> </p>
<p>As with most things in life, things are often clearer if we draw a picture. Let’s create a graph of our predicted values along with 95 % confidence intervals. There are many ways to do this (including using the <code>predict()</code> function) but perhaps an easier way is to use the <code>allEffects()</code> function from the <code>effects</code> package (install this if required). See <code>?allEffects</code> for more details of this function.</p>
<p> </p>
<pre class="r"><code>effs &lt;- allEffects(nereis.gls.final, se = list(level = 0.95))

plot(effs, lines = list(multiline = TRUE, lwd = 0.8), symbols = list(pch = 1), 
    confint = list(style = &quot;bars&quot;), lattice = list(key.args = list(border = FALSE, 
        title = &quot;Nutrient&quot;)), main = &quot;&quot;, xlab = &quot;polychaete biomass (g)&quot;, 
    ylab = &quot;nutrient concentration mg/l&quot;)</code></pre>
<p><img src="GLS_variance_heterogeneity_report_files/figure-html/q14c-1.png" width="480" style="display: block; margin: auto;" /></p>
<p> </p>
<p>I prefer the following plot as I find it clearer.</p>
<p> </p>
<pre class="r"><code>plot(effs, lines = list(lwd = 0.8), symbols = list(pch = 1), 
    confint = list(style = &quot;bars&quot;), main = &quot;&quot;, xlab = &quot;polychaete biomass (g)&quot;, 
    ylab = &quot;nutrient concentration mg/l&quot;, layout = c(1, 
        3))</code></pre>
<p><img src="GLS_variance_heterogeneity_report_files/figure-html/q14d-1.png" width="384" style="display: block; margin: auto;" /></p>
<p> </p>
<p>These plots confirm our intuition. The nutrient concentration does change with polychaete biomass but this change appears to be dependent on the type of nutrient measured. For PO<sub>3</sub> the nutrient concentration remains at a relatively low concentration regardless of polychaete biomass. For NO<sub>3</sub> the concentration reduces as polychaete biomass increases whereas for NH<sub>4</sub> the concentration increases with an increase in biomass.</p>
<p> </p>
<p>That’s more or less it. Well done and congratulations!</p>
<div style="page-break-after: always;"></div>
<div id="bonus-code" class="section level4">
<h4>Bonus code!</h4>
<p> </p>
<p>An alternative method to create a boxplot using the <code>ggplot()</code> function from the <code>ggplot2</code> package. We haven’t introduced you to <code>ggplot2</code> but if you are interested see <a href="https://intro2r.com/graphics-r.html">Chapter 5</a> of our ‘Introduction to R’ book.</p>
<p> </p>
<pre class="r"><code>ggplot(nereis, aes(x = fbiomass, y = concentration, fill = fnutrient)) + 
    geom_boxplot() + labs(x = &quot;polychaete biomass (g)&quot;, 
    y = &quot;concentration (mg/l)&quot;, fill = &quot;Biomass&quot;) + scale_fill_brewer(palette = &quot;RdBu&quot;)</code></pre>
<p><img src="GLS_variance_heterogeneity_report_files/figure-html/bonus1-1.png" width="672" /></p>
<p> </p>
<p>An alternative way to calculate and plot the predicted mean concentration for each group and associated 95% confidence intervals. This method requires you to install the <code>rms</code> package, use the <code>Gls()</code> function (note the capital G) to fit your model and the <code>Predict()</code> function (notice the capital P) to estimate the group means and approximate confidence intervals. Finally <code>ggplot()</code> is used to plot these values.</p>
<p> </p>
<pre class="r"><code>library(rms)
f &lt;- Gls(concentration ~ fbiomass * fnutrient, weights = vf3, 
    data = nereis)
w &lt;- as.data.frame(rms::Predict(f, fbiomass = c(&quot;0&quot;, &quot;0.5&quot;, 
    &quot;1&quot;, &quot;1.5&quot;, &quot;2&quot;), fnutrient = c(&quot;NH4&quot;, &quot;NO3&quot;, &quot;PO3&quot;)))

ggplot(w, aes(x = fbiomass, y = yhat, group = fnutrient, 
    colour = fnutrient)) + geom_errorbar(aes(ymin = lower, 
    ymax = upper), width = 0.1) + geom_line() + geom_point() + 
    labs(x = &quot;polychaete biomass (g)&quot;, y = &quot;concentration (mg/l)&quot;) + 
    scale_colour_brewer(name = &quot;nutrient type&quot;, palette = &quot;Dark2&quot;)</code></pre>
<p><img src="GLS_variance_heterogeneity_report_files/figure-html/bonus2-1.png" width="672" /></p>
<p> </p>
</div>
</div>
<div id="session-information" class="section level3">
<h3>Session Information</h3>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 4.0.3 (2020-10-10)
## Platform: x86_64-apple-darwin17.0 (64-bit)
## Running under: macOS Catalina 10.15.7
## 
## Matrix products: default
## BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_GB.UTF-8/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] rms_6.1-0        SparseM_1.78     Hmisc_4.4-2      Formula_1.2-4    survival_3.2-7   AICcmodavg_2.3-1 stringr_1.4.0    dplyr_1.0.2     
##  [9] ggplot2_3.3.2    knitr_1.30       effects_4.2-0    nlme_3.1-150     car_3.0-10       carData_3.0-4    lattice_0.20-41 
## 
## loaded via a namespace (and not attached):
##  [1] matrixStats_0.57.0  insight_0.11.1      RColorBrewer_1.1-2  tools_4.0.3         backports_1.2.0     R6_2.5.0           
##  [7] rpart_4.1-15        DBI_1.1.0           colorspace_2.0-0    raster_3.4-5        nnet_7.3-14         sp_1.4-4           
## [13] withr_2.3.0         tidyselect_1.1.0    gridExtra_2.3       curl_4.3            compiler_4.0.3      quantreg_5.75      
## [19] formatR_1.7         htmlTable_2.1.0     sandwich_3.0-0      unmarked_1.0.1      labeling_0.4.2      scales_1.1.1       
## [25] checkmate_2.0.0     polspline_1.1.19    mvtnorm_1.1-1       digest_0.6.27       foreign_0.8-80      minqa_1.2.4        
## [31] rmarkdown_2.5       rio_0.5.16          base64enc_0.1-3     jpeg_0.1-8.1        pkgconfig_2.0.3     htmltools_0.5.0    
## [37] lme4_1.1-26         highr_0.8           htmlwidgets_1.5.2   rlang_0.4.9         readxl_1.3.1        VGAM_1.1-4         
## [43] rstudioapi_0.13     generics_0.1.0      farver_2.0.3        zoo_1.8-8           zip_2.1.1           magrittr_2.0.1     
## [49] Matrix_1.2-18       Rcpp_1.0.5          munsell_0.5.0       abind_1.4-5         lifecycle_0.2.0     stringi_1.5.3      
## [55] multcomp_1.4-15     yaml_2.2.1          MASS_7.3-53         plyr_1.8.6          grid_4.0.3          parallel_4.0.3     
## [61] forcats_0.5.0       crayon_1.3.4        haven_2.3.1         splines_4.0.3       hms_0.5.3           pillar_1.4.7       
## [67] boot_1.3-25         estimability_1.3    codetools_0.2-18    stats4_4.0.3        glue_1.4.2          evaluate_0.14      
## [73] mitools_2.4         latticeExtra_0.6-29 data.table_1.13.4   png_0.1-7           vctrs_0.3.5         nloptr_1.2.2.2     
## [79] MatrixModels_0.4-1  cellranger_1.1.0    gtable_0.3.0        purrr_0.3.4         xfun_0.19           openxlsx_4.2.3     
## [85] xtable_1.8-4        survey_4.0          tibble_3.0.4        conquer_1.0.2       tinytex_0.27        cluster_2.1.0      
## [91] statmod_1.4.35      TH.data_1.0-10      ellipsis_0.3.1</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
